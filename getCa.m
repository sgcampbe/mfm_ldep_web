%***********************************************************************%
%   Markov Myofilament Model - getCa - Returns [Ca] for given time, t   %
%   File:   getCa.m                                                     %
%   Date Started: 8/9/2007                                              %
%   Author: Stuart Campbell                                             %
%   Description: This function will return a value or values of         %
%   intracellular Ca concentration for a given time point or vector of  %
%   time points.  Other arguements include Ca_min, Ca_max, and Ca_code, %
%   which determines the type of Ca function is used.                   %
%
%   12/28/11 - Added support to load and return Ca transients from files.
%   The file name must specify a .mat file containing two variables: t_data
%   and Ca_data.  To load from file, pass the file string in as a fourth 
%   entry in Ca_params.  Ca_code inside Ca_params will be ignored, and if
%   the other code entries are set to string values, then scaling will be
%   skipped, with the inherent scaling in the loaded structure used
%   instead.
%***********************************************************************%


function Ca_i = getCa(t, Ca_params)

if length(Ca_params) > 3    % If a file name is being passed in
    load(Ca_params{4});      % Should load Ca_data and t_data into workspace
    if ~ischar(Ca_params{2}) && ~ischar(Ca_params{3})   % If scaling is provided, scale the transient
        Ca_data = vnorm(Ca_data, 0.01); % Normalize trace
        Ca_min  = Ca_params{2};
        Ca_max  = Ca_params{3};
        Ca_i    = Ca_min + (Ca_max - Ca_min) * linInterp(t, t_data, Ca_data);
    else                % No scaling - use as is
        Ca_i = linInterp(t, t_data, Ca_data);
    end
    return
end

% If not loading from file, continue on and use Ca_code
        
Ca_code = Ca_params{1};
Ca_min  = Ca_params{2};
Ca_max  = Ca_params{3};


switch Ca_code
    case 1      % Constant Ca_i = Ca_max for all t
        Ca_i = ones(size(t)) * Ca_max;
    case 2      % Simple mono-exponential Ca transient scaled between Ca_min and Ca_max
        tau_Ca  = 14.1103;
        Ca_i = Ca_min + (Ca_max - Ca_min) * (t / tau_Ca) .* ...
               exp(1 - (t / tau_Ca));
    case 3      % Digitized Ca transient from Varian et al, AJP 2006
        t_data  = [0;4.9505;6.9307;8.9109;10.8911;12.8713;15.8416;19.802;28.7129;38.6139;47.5248;61.3861;76.2376;90.099;113.8614;143.5644;171.2871;197.0297;296.0396;];
        Ca_data = [0.1;0.1;0.1178;0.1713;0.4475;0.6614;0.8396;0.9644;1;0.9198;0.7861;0.6792;0.5188;0.4208;0.3139;0.2248;0.1624;0.1;0.1;];
        Ca_data = (Ca_max - Ca_min) * (Ca_data - 0.1) + Ca_min;
        Ca_i    = linInterp(t, t_data, Ca_data);
    case 4      % Digitized Ca transient from Janssen et al, 1997
        t_data  = [0;80.8081;95.9596;111.1111;131.3131;151.5152;161.6162;186.8687;202.0202;242.4242;308.0808;353.5354;419.1919;525.2525;676.7677;803.0303;959.596;1095.9596;1262.6263;];
        Ca_data = [0.1;0.1;0.1266;0.6379;0.8189;0.9734;0.9893;0.8296;0.558;0.5207;0.4568;0.3982;0.2811;0.2385;0.2065;0.1479;0.1213;0.1;0.1;];
        Ca_data = (Ca_max - Ca_min) * (Ca_data - 0.1) + Ca_min;
        Ca_i    = linInterp(t, t_data, Ca_data);
    case 5      % Digitized Ca transient from Dobrunz et al, 1995, figure 2a, Control twitch
        t_data  = [0;13.8888888888889;20.8333333333333;24.3055555555556;31.2500000000000;31.2500000000000;27.7777777777778;27.7777777777778;31.2500000000000;34.7222222222222;41.6666666666667;52.0833333333333;65.9722222222222;72.9166666666667;76.3888888888889;90.2777777777778;104.166666666667;114.583333333333;128.472222222222;138.888888888889;156.250000000000;177.083333333333;201.388888888889;215.277777777778;250;270.833333333333;305.555555555556;333.333333333333;368.055555555556;416.666666666667;461.805555555556;500;559.027777777778;614.583333333333;673.611111111111;743.055555555555;829.861111111111;920.138888888889;1027.77777777778;1138.88888888889;1263.88888888889;1402.77777777778;1631.94444444444;1975.69444444444;];
        Ca_data = [0.0965034965034964;0.0986013986013985;0.121678321678322;0.178321678321678;0.281118881118881;0.413286713286713;0.560139860139860;0.665034965034965;0.748951048951049;0.818181818181818;0.874825174825175;0.893706293706294;0.906293706293706;0.906293706293706;0.893706293706294;0.866433566433567;0.845454545454546;0.807692307692308;0.784615384615385;0.755244755244755;0.725874125874126;0.683916083916084;0.646153846153846;0.608391608391608;0.553846153846154;0.518181818181818;0.472027972027972;0.434265734265734;0.394405594405595;0.346153846153846;0.312587412587413;0.287412587412587;0.251748251748252;0.220279720279720;0.195104895104895;0.176223776223776;0.157342657342657;0.140559440559441;0.132167832167832;0.119580419580420;0.113286713286713;0.111188811188811;0.111188811188811;0.111188811188811;];
        Ca_i    = linInterp(t, t_data, Ca_data);
    case 6
        t_data  = [0;13.8888888888889;24.3055555555556;31.2500000000000;38.1944444444444;48.6111111111111;52.0833333333333;59.0277777777778;62.5000000000000;83.3333333333333;111.111111111111;138.888888888889;173.611111111111;215.277777777778;270.833333333333;312.500000000000;368.055555555556;451.388888888889;534.722222222222;611.111111111111;715.277777777778;819.444444444444;930.555555555555;1090.27777777778;1190.97222222222;1319.44444444444;1486.11111111111;1628.47222222222;1736.11111111111;1888.88888888889;1961.80555555556;1986.11111111111;];
        Ca_data = [0.146853146853147;0.146853146853147;0.190909090909091;0.283216783216783;0.356643356643357;0.446853146853147;0.499300699300699;0.524475524475525;0.539160839160839;0.541258741258741;0.530769230769231;0.516083916083916;0.495104895104895;0.469930069930070;0.448951048951049;0.427972027972028;0.406993006993007;0.392307692307692;0.375524475524476;0.356643356643357;0.331468531468532;0.308391608391608;0.293706293706294;0.281118881118881;0.266433566433566;0.251748251748252;0.247552447552448;0.237062937062937;0.226573426573427;0.220279720279720;0.220279720279720;0.220279720279720;];
        Ca_i    = linInterp(t, t_data, Ca_data);
    case 7      % Measured data from WT C57 mouse (prep 100302_m01_WT) at 2 Hz
        t_data  = [0, 4.36387588385167,9.40424478464623,14.2838927217469,19.2985114626162,24.2088087785879,29.1662161028093,34.1091279900319,39.0384326518117,44.0020937989957,48.9235142871234,53.8824100347031,58.8167459949430,63.7604310550280,68.7077363563858,73.6433033851868,78.5933495610835,83.5305377664834,88.4763597475272,93.4185516519102,98.3600276624121,103.305069849955,108.245418152473,113.190117779558,118.131750917397,123.074818850468,128.017932888466,132.959980894165,137.903548021464,142.845644885865,147.788825034538,152.731452626607,157.674131383281,162.617119860317,167.559622014371,172.502615542206,177.445230941606,182.388057714777,187.330838224061,192.273539976325,197.216387459435,202.159078078967,207.101899635361,212.044632619590,216.987408451191,221.930178799716,226.872930766144,231.815715801304,236.758457361193,241.701253610553,246.643980438558,251.586788985863,256.529515348106,261.472301375724,266.415082802634,271.357784570311,276.300663115770,281.243281538796,286.186193927537,291.128863860690,296.071619761635,301.014544318515,305.956988399891,310.900196673675,315.842497343539,320.785601753945,325.728331292550,330.670684403303,335.614361304560,340.555814224080,345.500015049178,350.441663468598,355.384700885818,360.328503780593,365.268714483216,370.215330873640,375.153709586207,380.100117914246,385.041573903444,389.981842482285,394.931717646602,399.863198181227,404.819332770474,409.750395986178,414.698369041798,419.647050984332,424.570125735813,429.545277084641,434.448813445834,439.427290908813,444.350001533970,449.285690815349,454.272148762937,459.123908877302,464.206962557103,469.013703975561,474.088372283924,479.042341441862,483.744588102333,489.449767880698,492.981306582697;];
        Ca_data = [0.2536; 0.253604464440207;0.248431350586152;0.234226979767655;0.232770375230323;0.220996333464402;0.269925537458329;0.601562428019020;1.09775700864867;1.36523041577399;1.40390771687001;1.47965131668387;1.57638842984092;1.61154461117293;1.67192555447081;1.72618877805166;1.71102494130293;1.70278024291882;1.72786551915676;1.72861794127016;1.70073361136409;1.70037338358059;1.66486107403892;1.54232525418184;1.49399568045197;1.50765301149096;1.43556306333952;1.37909613341625;1.36588703163214;1.29556743671301;1.21725422967979;1.16566353845272;1.10226716742475;1.03729694352970;0.992328589534485;0.932874077623761;0.861898408942717;0.836324221447632;0.817208477679315;0.761154946748569;0.727112132020570;0.709173548950241;0.646656938209698;0.578576144795460;0.566285157040351;0.572670004609550;0.544729088892126;0.541582616278598;0.586575161050868;0.570284868870373;0.506119517702267;0.485735154773669;0.474111883978659;0.461338090037718;0.469590171033110;0.455797985248673;0.421355363754808;0.413481670244424;0.425045945592540;0.412955650007730;0.383196321794954;0.375422338728034;0.373952381422968;0.352882373145637;0.344473987577017;0.359021511424438;0.348934050299802;0.317319088983125;0.316355309597530;0.334021366084162;0.339754579022540;0.338539996030410;0.328152140663569;0.316380762260843;0.309401143801681;0.295373750309225;0.287259902979083;0.293531302923398;0.300881957821469;0.303154694554592;0.300780259819586;0.300463353904565;0.287191886580149;0.259220744511098;0.265291524181781;0.295967730773535;0.291442589256944;0.270180866626964;0.263873634485549;0.248517659301734;0.236774892080749;0.250347698134063;0.259132491281670;0.258221900501949;0.260788060582813;0.264434589658700;0.270076108577655;0.252900673139853;0.225781218438852;0.232410060216918;0.248439834963697;];
        Ca_i    = linInterp(t, t_data, Ca_data);
    case 8      % Measured data from WT C57 mouse (prep 100302_m01_WT) at 4 Hz
        t_data  = [0, 4.36387588385167,9.40424478464623,14.2838927217469,19.2985114626162,24.2088087785879,29.1662161028093,34.1091279900319,39.0384326518117,44.0020937989957,48.9235142871234,53.8824100347031,58.8167459949430,63.7604310550280,68.7077363563858,73.6433033851868,78.5933495610835,83.5305377664834,88.4763597475272,93.4185516519102,98.3600276624121,103.305069849955,108.245418152473,113.190117779558,118.131750917397,123.074818850468,128.017932888466,132.959980894165,137.903548021464,142.845644885865,147.788825034538,152.731452626607,157.674131383281,162.617119860317,167.559622014371,172.502615542206,177.445230941606,182.388057714777,187.330838224061,192.273539976325,197.216387459435,202.159078078967,207.101899635361,212.044632619590,216.987408451191,221.930178799716,226.872930766144,231.815715801304,236.758457361193,241.701253610553,246.643980438558,251.586788985863,256.529515348106,261.472301375724,266.415082802634,271.357784570311,276.300663115770,281.243281538796,286.186193927537,291.128863860690,296.071619761635,301.014544318515,305.956988399891,310.900196673675,315.842497343539,320.785601753945,325.728331292550,330.670684403303,335.614361304560,340.555814224080,345.500015049178,350.441663468598,355.384700885818,360.328503780593,365.268714483216,370.215330873640,375.153709586207,380.100117914246,385.041573903444,389.981842482285,394.931717646602,399.863198181227,404.819332770474,409.750395986178,414.698369041798,419.647050984332,424.570125735813,429.545277084641,434.448813445834,439.427290908813,444.350001533970,449.285690815349,454.272148762937,459.123908877302,464.206962557103,469.013703975561,474.088372283924,479.042341441862,483.744588102333,489.449767880698,492.981306582697;];
        Ca_data = [0.57597; 0.575970796671416;0.578947277643046;0.570101813279474;0.516399282479330;0.455398598386168;0.494888279452149;0.718114638993902;1.13108813269150;1.60967285541963;1.95790427565734;2.08425236056548;2.09607871924972;2.13301221563972;2.19115258947371;2.22507184526152;2.23369175657859;2.21029223992155;2.14583164680171;2.07625669373150;2.05362094938400;2.01517481491478;1.91503626230810;1.85197562916112;1.81938439014669;1.70250688900465;1.54884700109685;1.49232050495117;1.51418951147833;1.47764700863245;1.32734447769587;1.16634659624447;1.08869785546934;1.07320291067615;1.06045896684544;1.00693638018978;0.935287975325745;0.894824792576625;0.876002531959196;0.857539930130125;0.828285496513138;0.759715725066617;0.684361892328468;0.666723975100924;0.703414859016758;0.727150326878495;0.663612980604759;0.557860895863575;0.531882913049064;0.576670809221789;0.572810531330203;0.498150746192520;0.463325023944286;0.492565955459076;0.497091845780606;0.493305811075939;0.507407076939146;0.490975448067677;0.480039348446956;0.488051037764392;0.470425845797143;0.461665276932635;0.471356983394922;0.464118329155098;0.444362212145225;0.427145072905414;0.427221758418620;0.414060418603181;0.360148954173227;0.346418300262173;0.403919389518659;0.444740881872254;0.435976792779730;0.405279562763859;0.387410034387904;0.405954411505684;0.414782549232033;0.397452473426548;0.382533004294327;0.363691368465770;0.351713543940659;0.353815040585400;0.359682913896427;0.374942463467130;0.386244782477029;0.383313417236669;0.371790030698872;0.359174530238967;0.356716125065178;0.345742476943857;0.335819437621107;0.362513730141723;0.371221918402329;0.330651388789396;0.297170114241901;0.306098372023662;0.353635711474653;0.365198968573884;0.330696524530955;0.332639027557668;0.353092608276730;];
        Ca_i    = linInterp(t, t_data, Ca_data);
    case 9      % Measured data from WT mouse, data shifted so stim times correspond to PS experiments (same as case 8 in Ldep_getCa)
        t_data  = [0,4.363875884,9.404244785,14.28389272,19.29851146,24.20880878,29.1662161,34.10912799,39.03843265,44.0020938,48.92351429,53.88241003,58.81674599,63.76043106,68.70773636,73.64330339,78.59334956,83.53053777,88.47635975,93.41855165,98.36002766,103.3050698,108.2454182,113.1901178,118.1317509,123.0748189,128.0179329,132.9599809,137.903548,142.8456449,147.788825,152.7314526,157.6741314,162.6171199,167.559622,172.5026155,177.4452309,182.3880577,187.3308382,192.27354,197.2163875,202.1590781,207.1018996,212.0446326,216.9874085,221.9301788,226.8729308,231.8157158,236.7584574,241.7012536,246.6439804,251.586789,256.5295153,261.4723014,266.4150828,271.3577846,276.3006631,281.2432815,286.1861939,291.1288639,296.0716198,301.0145443,305.9569884,310.9001967,315.8424973,320.7856018,325.7283313,330.6706844,335.6143613,340.5558142,345.500015,350.4416635,355.3847009,360.3285038,365.2687145,370.2153309,375.1537096,380.1001179,385.0415739,389.9818425,394.9317176,399.8631982,404.8193328,409.750396,414.698369,419.647051,424.5701257,429.5452771,434.4488134,439.4272909,444.3500015,449.2856908,454.2721488,459.1239089,464.2069626,469.013704,474.0883723,479.0423414,483.7445881,489.4497679,492.9813066;];
        Ca_data = [0.013006303,0.013006303,0.013006303,0.013006303,0.013006303,0.013006303,0.013006303,0.013006303,0.013006303,0.013006303,0.013006303,0.013006303,0.013006303,0.013006303,0.013006303,0.013006303,0.013006303,0.013006303,0.013006303,0.013006303,0.013006303,0.021625895,0.021628856,0.018197548,0.00877584,0.00780968,0,0.032454565,0.252428124,0.581552208,0.758966359,0.784620874,0.834861332,0.899026712,0.92234568,0.962396143,0.998388745,0.988330626,0.982861947,0.999500921,1,0.981504424,0.981265486,0.957710299,0.876432729,0.844375897,0.853434755,0.805617752,0.76816344,0.75940189,0.712759155,0.660814286,0.626594366,0.58454378,0.541449264,0.511621916,0.472185952,0.425108046,0.408144779,0.395465375,0.358285269,0.335704792,0.323806194,0.282339151,0.237181405,0.229028837,0.233263884,0.214730774,0.21264373,0.242487124,0.231681832,0.189121184,0.17560031,0.167890636,0.159417824,0.1648914,0.155743093,0.132897425,0.127674833,0.135345375,0.127325926,0.10758667,0.102430215,0.101455197,0.087479537,0.081902285,0.091551605,0.084860628,0.063890538,0.063251267,0.074969098,0.078771918,0.077966289,0.071076062,0.063268149,0.058638593,0.049334274,0.043952388,0.048112185,0.052987848,0.054495346;];
        Ca_i    = Ca_min + (Ca_max - Ca_min) * linInterp(t, t_data, Ca_data);
    case 10     % Measured data from 12 mo. old female rat; ENDO cell; paced at 0.5 Hz
        t_data  = [13;27;41;55;69;83;97;111;125;139;153;167;181;195;209;223;237;251;265;279;293;307;321;335;349;363;377;391;405;419;433;447;461;475;489;503;517;531;545;559;573;587;601;615;629;643;657;671;685;699;713;727;741;755;769;783;797;811;825;839;853;867;881;895;909;923;937;951;965;979;993;1007.00000000000;1021.00000000000;1035;1049;1063;1077;1091;1105;1119;1133;1147;1161;1175;1189;1203;1217;1231;1245;1259;1273;1287;1301;1315;1329;1343;1357;1371;1385;1399;1413;1427;1441;1455;1469;1483;1497;1511;1525;1539;1553;1567;1581;1595;1609;1623;1637;1651;1665;1679;1693;1707;1721;1735;1749;1763;1777;1791;1805;1819;1833;1847;1861;1875;1889;1903;1917;1931;];
        Ca_data = [0;-0.00495296400394638;0.0963566117143824;0.322577137972109;0.687384188303466;0.973685840485441;0.955695182780180;0.922963533687874;0.944683122537291;0.958739355316298;0.997223469015032;1;0.942865307118726;0.912381730167302;0.899716781728208;0.909825439720908;0.925360375879646;0.904147204512830;0.841051885646915;0.790080706009996;0.776558155869535;0.753744546290896;0.724977277991107;0.714779792313511;0.705966981086697;0.671419901239358;0.631218032270523;0.621697703535217;0.632957935560907;0.633954972590743;0.591503490691942;0.567865469289203;0.582804692448891;0.550149662114506;0.521071688088752;0.514890105023281;0.484115462103332;0.488474054709666;0.512212356249706;0.484634021922353;0.462942454026380;0.469090833933029;0.446949678037239;0.423259018094987;0.435506192479700;0.441910735587703;0.391558699527534;0.332336893613002;0.327667690787990;0.331629033261617;0.340727098317999;0.356850722398294;0.325465921735939;0.286168227251064;0.305214084335035;0.333326256093956;0.285444122797270;0.234218894126510;0.246885718715394;0.278956831895034;0.284305702194763;0.247281074330628;0.206186547037123;0.206580835567542;0.206913717436734;0.209699531720795;0.219885383725840;0.203650874909488;0.170723492725851;0.153524762949800;0.163098343884284;0.177156341262088;0.164263412673285;0.153167899544843;0.171301389123686;0.178165943268472;0.147414740229933;0.135957783997602;0.149308508047767;0.137093041002118;0.106591672256248;0.0912083228823967;0.101807328427329;0.0959872089193719;0.0765362810898164;0.0783831123994890;0.0905650644719635;0.0786608897076198;0.0563782562432662;0.0512930940663005;0.0504689441871777;0.0518294328038552;0.0567393920359088;0.0682262275533671;0.0601342242805936;0.0473146463609986;0.0629560218395939;0.0701146976046820;0.0533215374137311;0.0401820662843749;0.0439442710108588;0.0498029586924826;0.0663023752948843;0.0748957875238327;0.0423611749993844;0.0169001924197854;0.0253474190166232;0.0437446092145274;0.0794410411194439;0.0899178584189110;0.0504568097110728;0.0210442030996594;0.0211414327123305;0.0427966377731175;0.0241722640030806;-0.0257797288977121;-0.0109965136333847;0.0307171886782405;0.0275286269329601;-0.00124791803101571;-0.0228953942142540;-0.0408039333957849;-0.0529670174796281;-0.0562236944230830;-0.0345787608709723;-0.00645053772606960;-0.0251979630404568;-0.0565837693912568;-0.0654823510871506;-0.0609226102113981;-0.0309699020901103;0.000757340582130485;0.0111691142624406;0.00746599030398840;-0.0244034341939678;-0.0377123098890348;0.0124431510880488;-0.0454049372639103;];
        Ca_i    = Ca_min + (Ca_max - Ca_min) * linInterp(t, t_data, Ca_data);
end

return
        